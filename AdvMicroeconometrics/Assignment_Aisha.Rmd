---
title: "Adv. Microeconometrics Computer Assignment"
author: "A. Schmidt"
date: "11/19/2020"
output:
  pdf_document: default
bibliography: references.bib
---



```{r, message = FALSE, warning = FALSE, echo = FALSE}
# Verify if a package is already installed, if not, download and install before loading. 
chooseCRANmirror(graphics = FALSE, ind = 10)
if (!require("pacman")) install.packages("pacman")
pacman::p_load(ggplot2, MASS, knitr, ivreg, gridExtra, RColorBrewer, latex2exp)
```

```{r, message = FALSE, warning = FALSE, echo = FALSE}
# Prevents code from getting out of the page
## Works with almost everything except urls and strings.
opts_chunk$set(tidy.opts=list(width.cutoff=50),tidy=TRUE)
```

# 1 - Size distortions

Simulate data from the following model:

\begin{align*}
  Y &= X \beta + \varepsilon \\
  X &= Z\Pi + V
\end{align*}
where:
* $Y$ and $X$ are $n \times 1$ vectors which contain the endogenous variables;
* $Z$ is a $n \times k$ matrix of instruments;
* $\varepsilon$ and $V$ are $n \times 1$ vectors that contain disturbances.
* The different rows of $\left(\varepsilon\ \vdots\ V\right)$, are independently normally distributed, i.e., 

\begin{align*}
  \begin{pmatrix}
    \varepsilon_i \\
    V_i
  \end{pmatrix} \sim \mathcal{N}(0, \Sigma), \qquad 
  \Sigma =
  \begin{pmatrix}
  1 & \vdots & \rho \\
  \rho & & 1
  \end{pmatrix}
\end{align*}
* $n=100$, $k=10$, $\Pi = a \times e_{10}$ with $e_{10} \in \mathbb{R}^{10}$ whose first element is $1$ and the remaining are equal to zero.
* All elements from $Z$ are independently distributed and follows a standard normal distribution.
* $a \in \{0.3,.0.25, 0.2, 0.15, 0.1, 0.05, 0 \}$
* $\rho \in \{0.1, 0.2, 0.3, 0.4, 0.5, 0.6, 0.7, 0.8, 0.9, 0.95 \}$

```{r, echo = FALSE, warning = FALSE}
  # This block is a static block that is kept through all 5000 simulations


  # Preparing data
  set.seed(6969)

  # Magic numbers

  dn    <- 100
  dk    <- 10
  va    <- matrix(c(0.3, 0.25, 0.2, 0.15, 0.1, 0.05, 0), nrow = 7, ncol = 1)
  vrho  <- c(0.1, 0.2, 0.3, 0.4, 0.5, 0.6, 0.7, 0.8, 0.9, 0.95)
  dbeta <- 1
  dsim  <- 100

  
  ## INITIALIZATION ##
  # Generate the Z matrix
  mZ   = matrix(rep(0, dn*dk), nrow = dn, ncol = dk)
  
  for (j in 1:ncol(mZ)){
    mZ[,j] <- rnorm(nrow(mZ), mean = 0, sd = 1)
  }

  # Building a matrix with all Pi
  ve10 <- matrix(c(1, rep(0, dk-1)), nrow=10, ncol = 1)
  mPi  <- t(va %*% t(ve10))

```


```{r, echo = FALSE, warning = FALSE}
# This block simulates the model

fsimul <- function(dn, va, vrho, dBeta, mPi){
  mEV <- array(rep(0, dn*2*length(vrho)), dim = c(dn, 2, length(vrho)))
  
  # Builds the errors sampling from the multivariate normal distribution
  for (i in 1:length(vrho)){
    Sigma   <- matrix(c(1,vrho[i],vrho[i],1),2,2)
    for (j in 1:dn){
      pair    <- mvrnorm(n = 1, rep(0, 2), Sigma)
      mEV[j,,i] <- pair
    }
  }
  
  # Builds X
  lX = list(1,2,3,4,5,6,7,8,9,10)
  
  for(i in 1:length(lX)){
    lX[[i]] <- matrix(rep(0, dn*length(va)), nrow = dn, ncol = length(va))
  }
  
  
  for (j in 1:length(vrho)){
    for (i in 1:length(va)){
      lX[[j]][,i] = mZ %*% mPi[,i] + mEV[,2,j]
    }
  }
  
  # Builds Y
  lY = list(1,2,3,4,5,6,7,8,9,10)
  
  for(i in 1:length(lX)){
    lY[[i]] <- matrix(rep(0, dn*length(va)), nrow = dn, ncol = length(va))
  }
  
  for (j in 1:length(vrho)){
    for (i in 1:length(va)){
      lY[[j]][,i] = lX[[j]][,i] * dbeta + mEV[,1,j]
    }
  }
  
  return(list(lY, lX, mEV))
}
  
```


## Item 1

_For each value of $\alpha$ make a figure of the rejection frequency as a function of $\rho$ when testing $H_0: \beta = 0$ with $95\%$ significance using the $2SLS$ $t$-statistic (so five figures which show the rejection frequency as a function of $\alpha$).

```{r, echo = FALSE, warning = FALSE, eval = FALSE}
  # First, estimate using 2SLS
  
  ## First stage
  vPihat = list(1,2,3,4,5,6,7,8,9,10)
  
  for(i in 1:length(lX)){
    vPihat[[i]] <- 0*mPi
  }

  
  lXhat = list(1,2,3,4,5,6,7,8,9,10)
  
  for (i in 1:length(lX)){
    lXhat[[i]] <- 0 * lX[[i]]
  }
  

  for (j in 1:length(vrho)){
    for (i in 1:length(va)){
      first_stage     <- lm(lX[[j]][,i] ~ mZ - 1)
      vPihat[[j]][,i] <- first_stage$coefficients
      lXhat[[j]][,i]  <- first_stage$fitted.values
    }
  }
  
  mBetahat <- matrix(rep(0, length(va)*length(vrho)), ncol = length(vrho), nrow = length(va))
  lYhat = list(1,2,3,4,5,6,7,8,9,10)
  
  for (i in 1:length(lY)){
    lYhat[[i]] <- 0 * lY[[i]]
  }
  
  
  # Second stage
  for (j in 1:length(vrho)){
    for (i in 1:length(va)){
      second_stage      <- lm(lY[[j]][,i] ~ lXhat[[j]][,i] - 1)
      mBetahat[i,j]     <- second_stage$coefficients
    }
  }

```

Using a package

```{r, echo = FALSE, warning = FALSE, eval = TRUE}
  simul_results <- vector(mode = "list", length = dsim)
  
  for (k in 1:dsim){
    # Gets the model
    my_model <- list(1,2,3)
    my_model <- fsimul(dn, va, vrho, dBeta, mPi)
    lY       <- my_model[[1]]
    lX       <- my_model[[2]]
    mEV      <- my_model[[3]]

    mBetahat    <- matrix(rep(0, length(va)*length(vrho)), ncol = length(vrho), nrow = length(va))
    mpvaluebeta <- matrix(rep(0, length(va)*length(vrho)), ncol = length(vrho), nrow = length(va))
    mrejectbeta <- matrix(rep(0, length(va)*length(vrho)), ncol = length(vrho), nrow = length(va))
    
    for (j in 1:length(vrho)){
      for (i in 1:length(va)){
        model_2sls         <- ivreg(lY[[j]][,i] ~ lX[[j]][,i] - 1 | mZ[,1] + mZ[,2] + mZ[,3] + mZ[,4] + mZ[,5] + mZ[,6] + mZ[,7] + mZ[,8] + mZ[,9] + mZ[,10])
        mBetahat[i,j]      <- model_2sls$coefficients
        summarybeta        <- summary(model_2sls)
        mpvaluebeta[i,j]   <- summarybeta$coefficients[4]
        mrejectbeta[i,j]   <- ifelse(mpvaluebeta[i,j] < 0.05, 1, 0)
      }
    }
    simul_results[[k]] <- mrejectbeta
  }

  results_final <- 0*simul_results[[1]]

  for (i in 1:dsim){
    results_final <- results_final + simul_results[[i]]
  }

```

Graph for Q1

```{r, echo = FALSE, warning = FALSE, eval = TRUE}

   df1 <- data.frame(Rho = 0, Alpha = 0, Freq = 0)


   for (i in 1:length(va)){
     df  <- data.frame(Rho = vrho, Alpha = va[i], Freq = results_final[i,])
     df1 <- rbind(df1, df)
   }
   df1 <- df1[-1,]
   
   cores <- brewer.pal(7, "Dark2")
   df1$Freq <- df1$Freq/dsim

   
   p1 <- ggplot(df1[df1$Alpha == 0.30,], aes(x = factor(Rho), y = round((Freq/dsim)*100,0))) + 
      geom_bar(stat = 'identity', alpha = .4, colour = cores[1], fill = cores[1], width=0.6)+
      scale_x_discrete(TeX('$\\rho$'), breaks = NULL)+
      scale_y_continuous(TeX('# of times $H_0: \\beta = 0$ was rejected'), breaks = seq(0, 100, by = 10))+
      theme(axis.title = element_text(size=9), axis.text.x = element_text(size = 9), panel.border = element_blank(), axis.line = element_line(colour = "black"))+
      labs(title = TeX('$\\alpha = 0.30$'))+
      theme_bw()
      
   
   p2 <- ggplot(df1[df1$Alpha == 0.25,], aes(x = factor(Rho), round((Freq/dsim)*100,0))) + 
      geom_bar(stat = 'identity', alpha = .4, colour = cores[2], fill = cores[2], width=0.6)+
      scale_x_discrete(TeX('$\\rho$'), breaks = NULL)+
      scale_y_continuous(TeX('# of times $H_0: \\beta = 0$ was rejected'), breaks = seq(0, 100, by = 10))+
      theme(axis.title = element_text(size=9), axis.text.x = element_text(size = 9), panel.border = element_blank(), axis.line = element_line(colour = "black"))+
      labs(title = TeX('$\\alpha = 0.25$'))+
      theme_bw()
   
   p3 <- ggplot(df1[df1$Alpha == 0.20,], aes(x = factor(Rho), round((Freq/dsim)*100,0))) + 
      geom_bar(stat = 'identity', alpha = .4, colour = cores[3], fill = cores[3], width=0.6)+
      scale_x_discrete(TeX('$\\rho$'), breaks = NULL)+
      scale_y_continuous(TeX('# of times $H_0: \\beta = 0$ was rejected'), breaks = seq(0, 100, by = 10))+
      theme(axis.title = element_text(size=9), axis.text.x = element_text(size = 9), panel.border = element_blank(), axis.line = element_line(colour = "black"))+
      labs(title = TeX('$\\alpha = 0.20$'))+
      theme_bw()
   
   p4 <- ggplot(df1[df1$Alpha == 0.15,], aes(x = factor(Rho), round((Freq/dsim)*100,0))) + 
      geom_bar(stat = 'identity', alpha = .4, colour = cores[4], fill = cores[4], width=0.6)+
      scale_x_discrete(TeX('$\\rho$'), breaks = NULL)+
      scale_y_continuous(TeX('# of times $H_0: \\beta = 0$ was rejected'), breaks = seq(0, 100, by = 10))+
      theme(axis.title = element_text(size=9), axis.text.x = element_text(size = 9), panel.border = element_blank(), axis.line = element_line(colour = "black"))+
      labs(title = TeX('$\\alpha = 0.15$'))+
      theme_bw()
   
   p5 <- ggplot(df1[df1$Alpha == 0.10,], aes(x = factor(Rho), round((Freq/dsim)*100,0))) + 
      geom_bar(stat = 'identity', alpha = .4, colour = cores[5], fill = cores[5], width=0.6)+
      scale_x_discrete(TeX('$\\rho$'), breaks = NULL)+
      scale_y_continuous(TeX('# of times $H_0: \\beta = 0$ was rejected'), breaks = seq(0, 100, by = 10))+
      theme(axis.title = element_text(size=9), axis.text.x = element_text(size = 9), panel.border = element_blank(), axis.line = element_line(colour = "black"))+
      labs(title = TeX('$\\alpha = 0.10$'))+
      theme_bw()
   
   p6 <- ggplot(df1[df1$Alpha == 0.05,], aes(x = factor(Rho), round((Freq/dsim)*100,0))) + 
      geom_bar(stat = 'identity', alpha = .4, colour = cores[6], fill = cores[6], width=0.6)+
      scale_x_discrete(TeX('$\\rho$'), breaks = NULL)+
      scale_y_continuous(TeX('# of times $H_0: \\beta = 0$ was rejected'), breaks = seq(0, 100, by = 10))+
      theme(axis.title = element_text(size=9), axis.text.x = element_text(size = 9), panel.border = element_blank(), axis.line = element_line(colour = "black"))+
      labs(title = TeX('$\\alpha = 0.05$'))+
      theme_bw()
   
   p7 <- ggplot(df1[df1$Alpha == 0.00,], aes(x = factor(Rho), round((Freq/dsim)*100,0))) + 
      geom_bar(stat = 'identity', alpha = .4, colour = cores[7], fill = cores[7], width=0.6)+
      scale_x_discrete(TeX('$\\rho$'), breaks = NULL)+
      scale_y_continuous(TeX('# of times $H_0: \\beta = 0$ was rejected'), breaks = seq(0, 100, by = 10))+
      theme(axis.title = element_text(size=9), axis.text.x = element_text(size = 9), panel.border = element_blank(), axis.line = element_line(colour = "black"))+
      labs(title = TeX('$\\alpha = 0.00$'))+
      theme_bw()
   

pdf(file = "C:\\Users\\aisha\\OneDrive\\Documentos\\Mestrado Tinbergen\\Year 2\\Block 02\\Advanced Microeconometrics\\Computer assignment\\Mphil\\AdvMicroeconometrics\\Q1\\Fig01-Q1.pdf", width = 6, height = 3)
  grid.arrange(p1, p2, p3, ncol=3, nrow=1)
dev.off()  


pdf(file = "C:\\Users\\aisha\\OneDrive\\Documentos\\Mestrado Tinbergen\\Year 2\\Block 02\\Advanced Microeconometrics\\Computer assignment\\Mphil\\AdvMicroeconometrics\\Q1\\Fig02-Q1.pdf", width = 6, height = 3)
  grid.arrange(p4, p5, ncol=2, nrow=1)
dev.off()


pdf(file = "C:\\Users\\aisha\\OneDrive\\Documentos\\Mestrado Tinbergen\\Year 2\\Block 02\\Advanced Microeconometrics\\Computer assignment\\Mphil\\AdvMicroeconometrics\\Q1\\Fig03-Q1.pdf", width = 6, height = 3)
  grid.arrange(p6, p7, ncol=2, nrow=1)
dev.off()
```

## Question 2


